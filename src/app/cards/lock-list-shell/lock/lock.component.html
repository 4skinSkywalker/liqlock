<app-card-archetype>
    <ng-container class="card-header-content">
        <h5 class="mb-3">Lock details</h5>
        <a class="text-decoration-none" [routerLink]="['../']" [queryParams]="{ 'lockIntoView': lock?.index }"><i class="bi bi-arrow-left me-2"></i>Back to Lock list</a>
    </ng-container>
    <ng-container class="card-body-content">

        <ng-container *ngIf="!lock; else lockLoaded">
            <div class="text-center my-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </ng-container>
        <ng-template #lockLoaded>
            <div class="p-3">
                <div class="d-grid gap-2">
                    <div class="text-center" [class.text-primary]="lock.isLocked()">
                        <div>
                            <i class="status-icon bi"
                                [ngClass]="{
                                    'bi-lock-fill': lock.isLocked(),
                                    'bi-unlock': !lock.isLocked()
                                }"></i>
                        </div>
                        <span class="status-text">{{ !lock.isLocked() ? 'Unlocked' : 'Locked' }}</span>
                    </div>
                    <div>
                        <div><small class="text-muted">Index</small></div>
                        <span>{{ lock.index }}</span>
                    </div>
                    <div>
                        <div><small class="text-muted">Expiration date</small></div>
                        <span>{{ lock.expirationTime | formatDate }}
                            <i class="bi ms-2"
                                [ngClass]="{
                                    'bi-lock-fill': lock.isLocked(),
                                    'text-primary': lock.isLocked(),
                                    'bi-unlock': !lock.isLocked()
                                }"></i>
                        </span>
                    </div>
                    <div>
                        <div><small class="text-muted">Current owner</small></div>
                        <app-scanner-link [address]="lock.getOwner()"></app-scanner-link>
                    </div>
                    <div *ngIf="lock.transfers">
                        <div><small class="text-muted">Transfers of ownership</small></div>
                        <ul class="list-group">
                            <li class="list-group-item d-flex flex-wrap justify-content-between" *ngFor="let t of lock.transfers">
                                <div>
                                    <small class="text-muted">Old owner</small>
                                    <div>
                                        <app-scanner-link [address]="t.oldOwner"></app-scanner-link>
                                    </div>
                                </div>
                                <div>
                                    <small class="text-muted">New owner</small>
                                    <div>
                                        <app-scanner-link [address]="t.newOwner"></app-scanner-link>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <div><small class="text-muted">Token</small></div>
                        <div><span>{{ lock.token.symbol }}</span></div>
                        <app-scanner-link [address]="lock.token.address"></app-scanner-link>
                    </div>
                    <div>
                        <div><small class="text-muted">Value</small></div>
                        <div class="fs-4 lh-0">{{ lock.value | weiToDecimal: lock.token.decimals | formatMultiplier }}</div>
                        <div *ngIf="ownedBySelectedAccount"><small class="text-muted">Your balance of {{ lock.token.symbol }} is {{ lock.token.balance | weiToDecimal: lock.token.decimals | formatMultiplier }}</small></div>
                    </div>

                    <div *ngIf="ownedBySelectedAccount" class="p-3 my-4 border rounded">
                        <h4 class="mb-3">Functionalities</h4>

                        <ng-container *ngIf="hasToApprove; else functionalitiesGrid">
                            <div class="alert alert-dark" role="alert">
                                In order to Lock you need to grant allowance to our smart contract first. To proceed click on Approve.
                            </div>
                            <button *ngIf="hasToApprove"
                                class="btn btn-lg btn-outline-primary">Approve</button>
                        </ng-container>
                        <ng-template #functionalitiesGrid>
                            <div class="functionalities-grid">
                                <div>
                                    <div class="fs-5 lh-0">Add to lock</div>
                                    <p class="mb-2"><small class="text-muted">Add value to the locked amount</small></p>
                                    <div class="input-group mb-2">
                                        <input [formControl]="lockAddField"
                                            [ngClass]="{
                                                'is-valid': lockAddField.valid && (lockAddField.dirty || lockAddField.touched),
                                                'is-invalid': lockAddField.invalid && (lockAddField.dirty || lockAddField.touched)
                                            }"
                                            type="text"
                                            class="form-control"
                                            placeholder="Value to add"
                                            aria-label="Value to add"
                                            aria-describedby="button-addon">
                                        <button class="btn btn-primary"
                                            [class.disabled]="lockAddField.invalid || interactingWithSmartContract"
                                            (click)="lockAdd()">Add</button>
                                    </div>
                                    <div class="invalid-feedback d-block ps-3" *ngIf="lockAddField.errors && (lockAddField.dirty || lockAddField.touched)">
                                        <p *ngIf="lockAddField.errors.invalidAmount">Add amount is invalid</p>
                                        <p *ngIf="lockAddField.errors.amountTooLow">Add amount is too low</p>
                                        <p *ngIf="lockAddField.errors.amountTooHigh">Add amount is too high</p>
                                    </div>
                                </div>
                                <div>
                                    <div class="fs-5 lh-0">Extend unlock date</div>
                                    <p class="mb-2"><small class="text-muted">Extend the locking period</small></p>
                                    <div class="input-group mb-2">
                                        <input [formControl]="lockExtendField"
                                            [ngClass]="{
                                                'is-valid': lockExtendField.valid && (lockExtendField.dirty || lockExtendField.touched),
                                                'is-invalid': lockExtendField.invalid && (lockExtendField.dirty || lockExtendField.touched)
                                            }"
                                            [min]="minDate"
                                            [max]="maxDate"
                                            [readonly]="interactingWithSmartContract"
                                            type="datetime-local"
                                            class="form-control"
                                            placeholder="New unlock date"
                                            aria-label="New unlock date"
                                            aria-describedby="button-addon">
                                        <button class="btn btn-primary"
                                            [class.disabled]="lockExtendField.invalid || interactingWithSmartContract"
                                            (click)="lockExtend()">Extend</button>
                                    </div>
                                    <div class="invalid-feedback d-block ps-3" *ngIf="lockExtendField.errors && (lockExtendField.dirty || lockExtendField.touched)">
                                        <p *ngIf="lockExtendField.errors.required">New unlock date is required</p>
                                        <p *ngIf="lockExtendField.errors.tooFarBack">New unlock date can't be before current unlock date</p>
                                        <p *ngIf="lockExtendField.errors.tooFarAhead">Unlock date can't be after {{ maxDate }}</p>
                                    </div>
                                </div>
                                <div>
                                    <div class="fs-5 lh-0">Transfer ownership</div>
                                    <p class="mb-2"><small class="text-muted">Transfer ownership of the lock</small></p>
                                    <div class="input-group">
                                        <input [formControl]="lockTransferField" 
                                            [ngClass]="{
                                                'is-valid': lockTransferField.valid && (lockTransferField.dirty || lockTransferField.touched),
                                                'is-invalid': lockTransferField.invalid && (lockTransferField.dirty || lockTransferField.touched)
                                            }"
                                            [readonly]="interactingWithSmartContract"
                                            type="text"
                                            class="form-control"
                                            placeholder="New owner"
                                            aria-label="New owner"
                                            aria-describedby="button-addon">
                                        <button class="btn btn-primary"
                                            type="button"
                                            id="button-addon"
                                            [class.disabled]="lockTransferField.invalid || interactingWithSmartContract"
                                            (click)="lockTransfer()">Transfer</button>
                                    </div>
                                    <div class="invalid-feedback d-block ps-3" *ngIf="lockTransferField.errors && (lockTransferField.dirty || lockTransferField.touched)">
                                        <p *ngIf="lockTransferField.errors.invalidAddress">Given address is invalid</p>
                                    </div>
                                </div>
                                <div>
                                    <div class="fs-5 lh-0">Withdraw</div>
                                    <p class="mb-2"><small class="text-muted">Withdraw, even partially, the lock amount</small></p>
                                    <div class="input-group mb-2">
                                        <input [formControl]="lockWithdrawField"
                                            [ngClass]="{
                                                'is-valid': lockWithdrawField.valid && (lockWithdrawField.dirty || lockWithdrawField.touched),
                                                'is-invalid': lockWithdrawField.invalid && (lockWithdrawField.dirty || lockWithdrawField.touched)
                                            }"
                                            [attr.disabled]="(lock.isLocked() || interactingWithSmartContract) ? '' : null"
                                            type="text"
                                            class="form-control"
                                            placeholder="Value to take"
                                            aria-label="Value to take"
                                            aria-describedby="button-addon">
                                        <button class="btn btn-primary"
                                            [class.disabled]="lock.isLocked() || lockWithdrawField.invalid || interactingWithSmartContract"
                                            (click)="lockWithdraw()">Withdraw</button>
                                    </div>
                                    <div class="d-flex gap-2 ps-3">
                                        <button class="btn btn-sm btn-outline-primary"
                                            (click)="setWithdrawPercentage(.25)"
                                            [class.disabled]="lock.isLocked()  || interactingWithSmartContract">25%</button>
                                        <button class="btn btn-sm btn-outline-primary"
                                            (click)="setWithdrawPercentage(.5)"
                                            [class.disabled]="lock.isLocked()  || interactingWithSmartContract">50%</button>
                                        <button class="btn btn-sm btn-outline-primary"
                                            (click)="setWithdrawPercentage(.75)"
                                            [class.disabled]="lock.isLocked()  || interactingWithSmartContract">75%</button>
                                        <button class="btn btn-sm btn-outline-primary"
                                            (click)="setWithdrawPercentage(1)"
                                            [class.disabled]="lock.isLocked()  || interactingWithSmartContract">Max</button>
                                    </div>
                                    <div class="invalid-feedback d-block ps-3" *ngIf="lockWithdrawField.errors && (lockWithdrawField.dirty || lockWithdrawField.touched)">
                                        <p *ngIf="lockWithdrawField.errors.invalidAmount">Withdraw amount is invalid</p>
                                        <p *ngIf="lockWithdrawField.errors.amountTooLow">Withdraw amount is too low</p>
                                        <p *ngIf="lockWithdrawField.errors.amountTooHigh">Withdraw amount is too high</p>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </div>

                </div>
            </div>
        </ng-template>

    </ng-container>
    <ng-container class="card-footer-content">
        <app-connection-information></app-connection-information>
    </ng-container>
</app-card-archetype>
